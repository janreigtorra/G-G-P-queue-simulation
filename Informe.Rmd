---
title: "Avaluació de cues amb arribades per lots $G^{[P]}/G/1$"
subtitle: "Teoria de cues i simulació"
author: "Aitor Moruno Cuenca i Jan Reig Torra"
date: "6/3/2021"
output:
  pdf_document: 
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(123)
```


# Introducció 

En aquest petit informe mostrarem els resultats de la implementació d'un programa que ens permeti avaluar la recurrència d'una cua $G^{[P]}/G/1$. 

Les distribucions que tenim (corresponents al *NIUB: 20075042*) són les següents: 

- Distribucions del temps entre arribades (corresponents a paquets de $p_i$ clients): **Exponencial** amb $E(\tau) = 82 \rightarrow \lambda = \frac{1}{82}$
- Distribucions de temps de servei (corresponent a cada client): **4-Erlang** amb $E(x_i) = 26,1818$

La distribució del número de clients $p_i$ en cada paquet $i$ és: 

|j |  $Prob(p_i=j)$|
|--|---------------|
|1 | 0,125         |
|2 | 0,275         |
|3 | 0,350         |
|4 | 0,250         |


# Aproximació teòrica

Abans de fer la implementació del programa , calculem els valors de $\rho$, $L$, $L_q$, $W$ i $W_q$ (teòrics) mitjançant l'**aproximació d’Allen Cuneen**, que posteriorment, compararem amb els valors simulats.  

Si la distribució del temps entre servei dels clients és una 4-Erlang, hem de calcular la distribució de servei dels paquets. S'ha de tenir en compte que els paquets poden ser de 1, 2, 3 o 4 clients amb les probabilitats corresponents a la distribució de $p_i$. 

$E(x_i) = \frac{4}{\alpha}= 26.1818 \rightarrow \alpha = 0.1527779$

En el cas de que hi hagi 1 client per paquet, l'esperança del temps de servei del paquet serà de $E(X^{[1]}) = 26.1818$, en cas que hi hagi 2 clients per paquet $E(X^{[2]}) = 2 \cdot \frac{4}{\alpha} =  52.3636$, en cas que hi hagi 3 clients per paquet $E(X^{[3]}) = 2 \cdot \frac{4}{\alpha} =  78.5454$, i en cas que en siguin 4, $E(X^{[4]}) = 2 \cdot \frac{4}{\alpha} =  104.7272$

De tal manera que l'esperança del temps de servei dels paquets serà: 

$$E(X) = 0.125\cdot E(X^{[1]}) + 0.275\cdot E(X^{[2]}) + 0.350\cdot E(X^{[3]}) + 0.250\cdot E(X^{[4]}) = 71.3454$$
 
La variància de la distribució del temps de servei de paquets la podem calcular: 

$$V(X) = 0.125\cdot (E(X^{[1]}) -E(X))^2+ 0.275\cdot (E(X^{[2]}) -E(X))^2 + 0.350\cdot (E(X^{[3]}) -E(X))^2 + 0.250\cdot (E(X^{[4]}) -E(X))^2 = 650.7839$$

Per veure els càlculs de la distribució del temps de servei de paquets anar a l'*ANNEX 1*. 

El coeficient de desviació serà: $C_X = \frac{\sqrt{V(X)}}{E(X)} = 0.3575628$. 


```{r, echo = F}
Ea <- 82
lambda = 1/Ea


k = 4
Ex <-26.1818
alpha = k/ Ex
mu = 1/Ex

Ep <- 10/alpha
rho = Ep/Ea

EEEE <- 1/alpha *(0.125*4+0.275*8+0.35*12+0.25*16)

E1 = 4/alpha 
E2 = 8/alpha 
E3 = 12/alpha 
E4 = 16/alpha 

VV2 = 0.125*(E1 - EEEE)^2+ 0.275*(E2 - EEEE)^2+0.35*(E3 - EEEE)^2+0.25*(E4 - EEEE)^2
  
ccc2 = sqrt(VV2)/EEEE
rho = EEEE/Ea
```


Per tant, el model de cues dels paquets serà **$M/ G/ 1$** on $\lambda = \frac{1}{82}$ i $\mu = \frac{1}{71.3454}$. 

El factor de càrrega és $\rho = \frac{\lambda}{\mu} =  0.8700659$.

L'aproximació d'**Allen Cuneen** és la següent: 

$$L_q \thickapprox Lq_{M/M/1} \cdot \frac{C_{\tau}^2 + C_X^2 }{2} = \frac{\rho^2}{1-\rho} \cdot \frac{C_{\tau}^2 + C_X^2 }{2} = 3.285512$$

A partir de les fòrmules de Little podem calcular la resta de magnituds fonamentals: 

- Ocupacio mitjana al S.E.: $L = Lq + \rho = 4.155578$
- Temps mig de permenència al S.E.: $W = \frac{L}{\lambda } = 340.7574$
- Temps mig de permenència en cua: $Wq = \frac{Lq}{\lambda } = 269.412$

Per veure els càlculs d'aquestes magnituds anar a l'*ANNEX 2*. 


```{r, echo = F}
Lqtt <- rho^2/(1-rho)*(1+ccc2^2)/2
#Lqtt  

Ltt = Lqtt + rho
#Ltt
```


```{r, echo = F}
Wtt = Ltt/ lambda
#Wtt


Wqtt = Lqtt/ lambda
#Wqtt

Aproximacio <- c(Wqtt,Wtt,Lqtt,Ltt)
```



# Generador de variables aleatòries 

Generació **$p_i$** (número de clients per paquet): 

```{r}
generacio_p <- function (u){
  if (u <= 0.125){return(1)}else if (u>0.125 && u<=0.4){return(2)}
  else if(u>0.4 && u<=0.75) {return(3)}else  {return(4)}
}
```


Generació del **temps entre arribades** per a paquets de mida $p_i$ clients: 

```{r}
arribades <- function(u){
return(-log(runif(u))/lambda)
  }
```


Generació del **temps de servei** per a clients: 

```{r}
servei <- function(u){
return(-log(prod(runif(u)))/alpha)
}
```



# Implementació del programa

Per tal de dur a terme el bucle que ens calcula tota la simulació del model de cues, s'ha realitzat mitjançant codi R. Per veure el codi, anar al document *Informe.Rmd* o a l'*ANNEX 3*. Els resultats de la simulació que es mostren a la pràctica, corresponen a una simulació d'un total de n = 10.000 paquets. 




```{r, echo = F}
k = 4
Ex <-26.1818
alpha = k/ Ex
mu = 1/Ex
Ea <- 82
lambda = 1/Ea

n = 10000    ## INPUT: Num de paquets a generar

N = 0


t <- numeric()
p <- numeric()
theta <- numeric(0)
thetac <- matrix(nrow = n, ncol = 4)
x <- matrix(nrow = n, ncol = 4)
tsc <- matrix(nrow = n, ncol = 4)
ts <- numeric()
X <- numeric()

Lc <- matrix(nrow = n, ncol = 4)
Lqc <- matrix(nrow = n, ncol = 4)
LTc <- matrix(nrow = n, ncol = 4)
LTqc <- matrix(nrow = n, ncol = 4)
Ltotalc = 0
Ltotalqc = 0
Wc = 0
Wqc = 0

L <- numeric()
LTq <- numeric()
Ltotal = 0
Ltotalq = 0
LT <- numeric()
W = 0
Lq <- numeric()
Wq = 0
  

t[1] <- 0
p[0] <- 0
theta[0] <- 0

tau<- numeric()
```


```{r, echo = F}


for (i in 1:n){
  
  p[i] <- generacio_p(runif(1))
  
  tsc [i,1] <- max(thetac[i-1,p[i-1]],t[i], na.rm = T) # instant entrada en el SS del client 1 del paquet i
  x[i,1] <- -log(prod(runif(4)))/alpha 
  
 thetac[i,1] <- tsc[i,1] + x[i,1]       # instant de sortida del SE del client 1 del paquet i

 
 if(p[i]>1){
 for (j in 2:p[i]){
   
  
    tsc [i,j] <- max(thetac[i,j-1],t[i], na.rm = T) # instant entrada en el SS del client j del paquet i
   x[i,j] <- servei(4)   # pk es un 4-Erlang
   thetac[i,j] <- max(thetac[i,j-1],0) + x[i,j]  
 } 
 }

 ts[i] <- max(theta[i-1], t[i], na.rm = T)
 X[i] = sum(x[i,], na.rm = T)
 theta[i] = ts[i]+ X[i]

 
 # Recollida estadístics de clients
 
  for(j in 1:p[i]){
   Lc[i,j] = thetac[i,j] - t[i]     # temps de permanència al SE del client j (= wc[j+r])
   Lqc[i,j] = tsc[i,j] - t[i]    # temps de permanència cua del client j (= wc[j+r])
   
   Ltotalc = Ltotalc +  Lc[i,j]
   LTc[i,j] = Ltotalc/(t[i])  # Serà lu del gràfic 
   
   Ltotalqc = Ltotalqc +  Lqc[i,j]
   LTqc[i,j] = Ltotalqc/(t[i])    # no se si cal 
   
   Wc = Wc +  Lc[i,j] 
   Wqc = Wqc +  Lqc[i,j]
      }
 
 N = N + p[i]
 
 if(i<n){
   tau[i] = arribades(1)
   t[i+1] = t[i] + tau [i] 
 }
 

 # Recollida estadístics de paquets
 
  L[i] <- theta[i] - t[i]   # (= w[i]) temps de permenència al SE del paquet i 
  Ltotal <- Ltotal + L[i]
  LT[i] <- Ltotal / (t[i]-t[1])
  W <- W + L[i]
  
  
  Lq[i] <- ts[i]-t[i]   # (= wq[i]) temps de permenència en cua del paquet i 
  Ltotalq <- Ltotalq + Lq[i]
  LTq[i] <- Ltotalq / (t[i]-t[1]) #No ho posa 
  Wq <- Wq + Lq[i]
  
  
}
```



# Presentació de resultats de la simulació 


## El factor de càrrega $\rho$

```{r}
mean(X)/mean(tau)
```


## La ocupació mitjana del S.E. $\mathcal{L}$ i de la cua $\mathcal{L}_q$ en número de paquets.

L paquets:

```{r}
Lresultat = Ltotal/t[n];  Lresultat
```

Lq paquets: 

```{r}
Lqresultat = Ltotalq/t[n];  Lqresultat
```

### Evolució de $\mathcal{L}$ i $\mathcal{L}_q$ paquets

```{r, echo = F,  out.width = "70%", fig.align="center"}
plot(LT[2:n], type = "l",  col ="indianred")
lines(LTq[2:n], col = "lightgoldenrod3")
legend ("bottomright", c("L paquets", "Lq paquets"), col = c("indianred", "lightgoldenrod3"), lty = c(1,1))
```

Observem que el gràfic corresponent a la L i Lq dels paquets s'ha estabilitzat amb una simulació de n = 10.000 clients. 


## La ocupació mitjana del S.E. $L$ i de la cua $L_q$ en número de clients.

L clients:
```{r}
Lresultatc = Ltotalc/t[n];  Lresultatc
```

Lq clients:

```{r}
Ltotalqc/t[n]
```



### Evolució de $\mathcal{L}$ i $\mathcal{L}_q$ clients:

```{r, echo = F,  out.width = "70%", fig.align="center"}
plot(as.vector(t(LTc))[4:N], type = "l", col ="indianred")
lines(as.vector(t(LTqc))[4:N], col = "lightgoldenrod3")
legend ("bottomright", c("L clients", "Lq clients"), col = c("indianred", "lightgoldenrod3"), lty = c(1,1))
```

Observem que el gràfic corresponent a la L i Lq dels clients s'ha estabilitzat amb una simulació de n = 10.000 clients. 


## El temps mig per client de permanència en el S.E $\mathcal{W}$ i en la cua $\mathcal{W_q}$ dels paquets.

W de paquets:
```{r}
W/n
```

Wq de paquets:
```{r}
Wq/n
```

## El temps mig per client de permanència en el S.E $W$ i en la cua $W_q$ dels clients.

W de clients:

```{r}
Wc/N
```

Wq de clients:

```{r}
Wqc/N
```


## Histogrames 

**Gràfic temps d'arribada de paquets**

```{r, echo = F, out.width = "60%", fig.align="center"}
hist(tau, main = "Histograma dels temps d'arribada", col = "lightgoldenrod", cex.main = 1)
```

**Gràfic temps de servei de paquets i clients**

```{r, echo = F, out.width = "80%", fig.align="center"}
par(mfrow = c(1,2))
hist(X, main = "Histograma temps de servei paquets", col = "lightgoldenrod", cex.main =  0.7)
hist(x, main = "Histograma temps de servei clients", col = "lightgoldenrod1", cex.main = 0.7)
```


Per veure el codi de la realització dels gràfics anar a l'*ANNEX 4*. 


# Comparació resultats de l'aproximació amb la simulació


```{r, echo = F, fig.align="center"}
CLIENTS <- c(Wqc/N, Wc/N, Ltotalqc/t[n], Ltotalc/t[n])
PAQUETS <- c(Wq/n, W/n, Ltotalq/t[n], Ltotal/t[n])
taula <- data.frame( CLIENTS,  PAQUETS, Aproximacio, row.names = c("Wq", "W", "Lq", "L"))
names(taula) <- c("Simulació Clients", "Simulació Paquets", "Aproximació (teòrica) paquets")

library(kableExtra)
kbl(taula)
```

Compararem els resultats que hem obtingut de les magnituds corresponents als paquets, tant les magnituds teòriques com les simulades mitjançant el codi implementat. El número de paquets en cua i el número de paquets en el sistema d'espera és molt semblant entre el càlcul teòric i el simulat, per tant, això és bon indicador. 

Destacar, que el temps mig d'espera en cua pels clients és major que el temps mig en el sistema d'espera en cua dels paquets. Respecte la comparativa entre les magnituds de temps, tenim que les magnituds dels paquets del temps d'espera en cua i de temps en el S.E són lleugerament superiors a les teòriques (però molt semblants). El temps mig d'espera en cua dels paquets teòric és de 269.412, mentre que el simulat és de 277.664. El temps d'espera teòric dels paquets en el S.E és de 340.7574 i el simulat 349.082, són força semblants malgrat que la simulació ha sobreestimat la magnitud.


